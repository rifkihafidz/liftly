name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Discord Notification - Start
        run: |
          curl -H "Content-Type: application/json" \
          -X POST \
          -d '{
            "embeds": [{
              "title": "üöÄ Deployment Started",
              "description": "Building and deploying **Liftly** to GitHub Pages...",
              "color": 3447003,
              "fields": [
                { "name": "Branch", "value": "${{ github.ref_name }}", "inline": true },
                { "name": "Commit", "value": "`${{ github.sha }}`", "inline": true }
              ]
            }]
          }' \
          ${{ secrets.DISCORD_WEBHOOK }}

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: any

      - name: Enable Web
        run: flutter config --enable-web

      - name: Build Web
        run: flutter build web --release --base-href /liftly/

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build/web
          publish_branch: gh-pages

      - name: Discord Notification - Success
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
          -X POST \
          -d '{
            "embeds": [{
              "title": "‚úÖ Deployment Successful",
              "description": "Liftly has been successfully deployed to GitHub Pages!",
              "color": 3066993,
              "url": "https://${{ github.repository_owner }}.github.io/liftly/"
            }]
          }' \
          ${{ secrets.DISCORD_WEBHOOK }}

      - name: Discord Notification - Failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
          -X POST \
          -d '{
            "embeds": [{
              "title": "‚ùå Deployment Failed",
              "description": "Something went wrong during the Liftly deployment process.",
              "color": 15158332,
              "fields": [
                { "name": "Reason", "value": "Check GitHub Actions logs for details." }
              ]
            }]
          }' \
          ${{ secrets.DISCORD_WEBHOOK }}
