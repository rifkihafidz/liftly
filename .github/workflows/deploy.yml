name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract Metadata
        id: extract_metadata
        run: |
          VERSION=$(grep '^version: ' pubspec.yaml | cut -d ' ' -f 2)
          MESSAGE=$(git log -1 --pretty=%s)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "COMMIT_MESSAGE=$MESSAGE" >> $GITHUB_ENV

      - name: Discord Notification - Start
        run: |
          curl -H "Content-Type: application/json" \
          -X POST \
          -d '{
            "embeds": [{
              "title": "üöÄ Deployment Started",
              "description": "Building and deploying **Liftly v${{ env.VERSION }}**...",
              "color": 3447003,
              "fields": [
                { "name": "Version", "value": "`${{ env.VERSION }}`", "inline": true },
                { "name": "Commit", "value": "${{ env.COMMIT_MESSAGE }}", "inline": false }
              ]
            }]
          }' \
          ${{ secrets.DISCORD_WEBHOOK }}

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: any

      - name: Enable Web
        run: flutter config --enable-web

      - name: Build Web
        run: flutter build web --release --base-href /liftly/

      - name: Generate Version JSON
        run: |
          echo "{\"version\": \"${{ env.VERSION }}\"}" > build/web/version.json

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build/web
          publish_branch: gh-pages

      - name: Discord Notification - Success
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
          -X POST \
          -d '{
            "embeds": [{
              "title": "‚úÖ Deployment Successful",
              "description": "Liftly **v${{ env.VERSION }}** is live!",
              "color": 3066993,
              "fields": [
                { "name": "Commit", "value": "${{ env.COMMIT_MESSAGE }}", "inline": false }
              ],
              "url": "https://${{ github.repository_owner }}.github.io/liftly/"
            }]
          }' \
          ${{ secrets.DISCORD_WEBHOOK }}

      - name: Discord Notification - Failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
          -X POST \
          -d '{
            "embeds": [{
              "title": "‚ùå Deployment Failed",
              "description": "Deployment of **v${{ env.VERSION }}** failed.",
              "color": 15158332,
              "fields": [
                { "name": "Commit", "value": "${{ env.COMMIT_MESSAGE }}", "inline": false },
                { "name": "Reason", "value": "Check GitHub Actions logs for details." }
              ]
            }]
          }' \
          ${{ secrets.DISCORD_WEBHOOK }}
